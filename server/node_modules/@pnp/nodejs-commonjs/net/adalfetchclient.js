"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AdalFetchClient = void 0;
var adal_node_1 = require("adal-node");
var common_1 = require("@pnp/common-commonjs");
var fetch_js_1 = require("./fetch.js");
var AdalFetchClient = /** @class */ (function () {
    function AdalFetchClient(_tenant, _clientId, _secret, _resource, _authority) {
        if (_resource === void 0) { _resource = "https://graph.microsoft.com"; }
        if (_authority === void 0) { _authority = "https://login.windows.net"; }
        this._tenant = _tenant;
        this._clientId = _clientId;
        this._secret = _secret;
        this._resource = _resource;
        this._authority = _authority;
        this.authContext = new adal_node_1.AuthenticationContext((0, common_1.combine)(this._authority, this._tenant));
    }
    AdalFetchClient.prototype.fetch = function (url, options) {
        if (!(0, common_1.objectDefinedNotNull)(options)) {
            options = {
                headers: new Headers(),
            };
        }
        else if (!(0, common_1.objectDefinedNotNull)(options.headers)) {
            options = (0, common_1.assign)(options, {
                headers: new Headers(),
            });
        }
        if (!(0, common_1.isUrlAbsolute)(url)) {
            url = (0, common_1.combine)(this._resource, url);
        }
        return this.acquireToken().then(function (token) {
            options.headers.set("Authorization", token.tokenType + " " + token.accessToken);
            return (0, fetch_js_1.fetch)(url, options);
        });
    };
    AdalFetchClient.prototype.acquireToken = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.authContext.acquireTokenWithClientCredentials(_this._resource, _this._clientId, _this._secret, function (err, token) {
                if (err) {
                    reject(err);
                }
                else {
                    resolve(token);
                }
            });
        });
    };
    return AdalFetchClient;
}());
exports.AdalFetchClient = AdalFetchClient;
//# sourceMappingURL=adalfetchclient.js.map